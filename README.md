# Next-Gen-Auth

A basic multi-page rails demo app created to showcase [Shopify's Next-Gen
Auth][1] using [Turbolinks][2]. This demo shows how to convert multi-page apps
into Next-Gen Auth enabled apps.

If you have a regular multi-page app and you want to use the new Session Token
Auth but you're unsure or not yet ready to convert your app to an SPA (Single
Page App), you can still use Session Tokens by converting your app to use
Turbolinks. Turbolinks is a JavaScript library that makes your application
behave as if it were a single-paged application.

## Getting started

> __Important:__ The session token feature is currently restricted to 
> participants of a private beta. The feature is scheduled for general release in
> Summer 2020.

If you are looking to install this app on your own testing environment, and
already have a `Shopify API Key` and `Shopify API Secret` [from your partners
dashboard][7], you can pull this repository and run the following:

```console
$ bundle install
$ yarn install
$ rails db:migrate
```
See [this section][3] for a guide on setting up your `.env` file.

You will also need to use [ngrok][4] to make `localhost:3000` available to the
internet. You should use the secure HTTPS URL generated by ngrok to create your
app with on your Partners dashboard.

To start the app, simply run:

```console
$ rails s
```

Your requests to protected resources should be secured with an `Authorization:
Bearer token` header.

![App dashboard][s2]

_**Above:** A sample multi-paged app with an authenticated landing page._

![App requests][s1]

_**Above:** Requests made to protected resources are authenticated using JWTs._

## Enabling Turbolinks on your app

The official [Turbolinks GitHub guide][2] is an excellent resource on getting
started with Turbolinks. Below are the steps taken to bootstrap Turbolinks on
this sample app.

1. Add the `turbolinks` gem to your Gemfile:

```rb
gem 'turbolinks', '~> 5'
```

2. Run `bundle install`.

3. Add the `turbolinks` package to your application: `yarn add turbolinks`.

4. Add the following line to `app/javascript/packs/application.js` if your app
uses webpack to manage its manifest files:

```js
require("turbolinks").start()
```

## Making authorized requests to protected resources

Before you can navigate to protected resources using Turbolinks, you should
fetch an authenticated session token. This sample app creates a `/widgets`
resource that is protected. It requires JWT authorization to read and
write.

1. In `config/initializrs/shopify_app.rb` add the following lines to the `ShopifyApp.configure` block:

```rb
ShopifyApp.configure do |config|
  â€¦
  config.allow_jwt_authentication = true
  config.myshopify_domain = ENV['SHOPIFY_DOMAIN']
end

ShopifyAPI::Session.myshopify_domain = ENV['SHOPIFY_DOMAIN']
```

* `config.allow_jwt_authentication = true` ensures that your app is configured to allow JWT-based
  authentication
* You should also edit `app/views/layouts/embedded_app.html.erb` so that it looks like this:

```rb
<%= content_tag(:div, nil, id: 'shopify-app-init', data: {
  api_key: ShopifyApp.configuration.api_key,
  shop_origin: params[:shop] || @current_shopify_session&.domain,
  load_path: params[:return_to] || home_path ,
  debug: Rails.env.development?
} ) %>
```

* `load_path` gives your app some place to redirect to once a Session Token is received

2. Assuming your `shopify_app` gem is updated to at least release
[`13.3.0`][5], ensure that `app/controllers/application_controller.rb`
resembles the following:

```rb
class ApplicationController < ActionController::Base
  include ShopifyApp::EmbeddedApp
  include ShopifyApp::RequireKnownShop

  layout 'embedded_app'

  def index
  end
end
```

* `ApplicationController` validates the shop through `ShopifyApp::RequireKnownShop`. If
the shop does not have the app installed, it will trigger the install flow.

3. Create a new view `app/views/application/index.html.erb`. This will be the
view that is rendered during the time it takes your app to fetch the Session
Token.

```html
<div>Loading...</div>
```

* Edit the `root` route in `routes.rb` to point to this loading page as well.

```rb
Rails.application.routes.draw do
  resources :widgets
  root :to => 'application#index'
  get '/home', to: 'home#index', as :home
  mount ShopifyApp::Engine, at: '/'
  # For details on the DSL available within this file, see https://guides.rubyonrails.org/routing.html
end
```

### Fetching a session token

The preferred method of fetching an authenticated JWT session token is by using
the `app-bridge-utils` library. It provides the helper method `getSessionToken`
that fetches a session token for you.

1. Ensure your app includes `app-bridge-utils` with a release version of at
least [`1.22.0`][6]:

```console
$ yarn add @shopify/app-bridge-utils@1.22.0
```

2. Import the `app-bridge-utils` library method `getSessionToken` in
`apps/javascript/shopify_app/shopify_app.js`:

```js
import { getSessionToken } from "@shopify/app-bridge-utils";
```

* `getSessionToken()` takes as argument an instance of app-bridge. If you
bootstrapped your application using `shopify_app`, one instance can be found
in `app/javascript/shopify_app/shopify_app.js`. The function
`getSessionToken()` returns an authenticated JWT token.
* This function does not auto-refresh tokens, so subsequent calls to refresh the
token will be needed.

3. Use `getSessionToken()` to fetch a JWT token. After the initial successful
fetch, use Turbolinks to redirect your application to its protected home page
resource, away from the loading page. This can be done in
`app/javascript/shopify_app/shopify_app.js`:

```js
import { getSessionToken } from "@shopify/app-bridge-utils";

document.addEventListener("DOMContentLoaded", async () => {
  var data = document.getElementById("shopify-app-init").dataset;
  var AppBridge = window["app-bridge"];
  var createApp = AppBridge.default;
  window.app = createApp({
    apiKey: data.apiKey,
    shopOrigin: data.shopOrigin,
  });

  ...

  // Wait for the token before trying to load an authenticated page
  await retrieveToken(app);
  Turbolinks.visit(data.loadPath);

  // Keep requesting the token every 50 seconds 
  keepRetrievingToken(app);
});

async function retrieveToken(app) {
  window.sessionToken = await getSessionToken(app);
}

function keepRetrievingToken(app) {
  setInterval(() => {
    retrieveToken(app);
  }, 50000);
}

document.addEventListener("turbolinks:request-start", function (event) {
  var xhr = event.data.xhr;
  xhr.setRequestHeader("Authorization", "Bearer " + window.sessionToken);
});

document.addEventListener("turbolinks:render", function () {
  $("form, a[data-method=delete]").on("ajax:beforeSend", function (event) {
    const xhr = event.detail[0];
    xhr.setRequestHeader("Authorization", "Bearer " + window.sessionToken);
  });
});
```

* Event listeners are added to both `turbolinks:request-start` and
`turbolinks:render` to set the appropriate `Authorization: Bearer Token` headers
before making requests.
* Turbolinks visits it's root `home_path` after a Session Token has been
retrieved and added to the document request headers.
* `keepRetrievingToken()` requests a refreshed token every 50 seconds or so.
This helps ensure your subsequent requests to protected resources are authorized.

[//]: # "Links"
[s1]: public/screenshot-1.png
[s2]: public/screenshot-2.png
[1]: https://drive.google.com/open?id=1KuWZc10Hnp0vCfR8ulYHVlazjA1RfXx9iDHb2d5e6Hk
[2]: https://github.com/turbolinks/turbolinks
[3]: https://github.com/Shopify/next-gen-auth-app-demo#make-your-app-react-graphql-and-shopify_app-ready
[4]: https://www.shopify.in/partners/blog/shopify-admin-authenticate-app 
[5]: https://github.com/Shopify/shopify_app/releases/tag/v13.3.0
[6]: https://www.npmjs.com/package/@shopify/app-bridge/v/1.22.0
[7]: https://shopify.dev/tutorials/build-a-shopify-app-with-node-and-react/embed-your-app-in-shopify#get-a-shopify-api-key
